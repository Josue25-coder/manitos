<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Practicando: {{ vocal }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='practica.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>
  
<header>
  <div class="back-container">
    <a href="{{ url_for('index') }}" class="btn-back">‚¨Ö Volver</a>
  </div>
  <h2>Practicando: {{ vocal }}</h2>
  <p>Entrena con tu IA personalizada para mejorar tu precisi√≥n</p>
</header>

<!-- M√©tricas -->
<div class="metrics">
  <div class="metric">
    <h3>Intentos</h3>
    <p id="intentos">0</p>
  </div>
  <div class="metric">
    <h3>Correctos</h3>
    <p id="correctos">0</p>
  </div>
  <div class="metric">
    <h3>Racha Actual</h3>
    <p id="racha">0</p>
  </div>
  <div class="metric">
    <h3>Precisi√≥n</h3>
    <p id="precision">0%</p>
  </div>
</div>

<!-- Contenido principal -->
<div class="main-content">
  <!-- C√°mara -->
  <div class="card">
    <h3>C√°mara de Aprendizaje</h3>
    <video id="webcam" autoplay playsinline width="640" height="480"></video>
    <canvas id="output" width="640" height="480"></canvas>
    <div class="controls">
      <button id="playBtn" class="btn-play">‚ñ∂Ô∏è Play</button>
      <button id="stopBtn" class="btn-stop">‚èπ Detener</button>
      <button id="resetBtn" class="btn-restart">üîÑ Reiniciar</button>
    </div>
  </div>

  <!-- Progreso -->
  <div class="card">
    <h3>Progreso de Aprendizaje</h3>
    <p><b>Objetivo Actual:</b> {{ vocal }}</p>

    <p>Precisi√≥n de la Sesi√≥n</p>
    <div class="progress-bar"><span id="precision-bar"></span></div>

    <h4>Se√±ales Disponibles:</h4>
    <div class="signal-list">
      <div class="signal">A</div>
      <div class="signal">E</div>
      <div class="signal">I</div>
      <div class="signal">O</div>
      <div class="signal">U</div>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  const videoElement = document.getElementById("webcam");
  const canvasElement = document.getElementById("output");
  const canvasCtx = canvasElement.getContext("2d");
  const vocalObjetivo = "{{ vocal }}";
  let recognitionOn = false;

  // Inicializar MediaPipe Hands
  const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });
  hands.setOptions({
    maxNumHands: 1,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5
  });
  hands.onResults(onResults);

  const camera = new Camera(videoElement, {
    onFrame: async () => {
      if (recognitionOn) {
        await hands.send({ image: videoElement });
      }
    },
    width: 640,
    height: 480
  });

  // Play
  document.getElementById("playBtn").addEventListener("click", () => {
    recognitionOn = true;
    camera.start();
  });

  // Stop
  document.getElementById("stopBtn").addEventListener("click", () => {
    recognitionOn = false;
  });

  // Reset
  document.getElementById("resetBtn").addEventListener("click", () => {
    fetch("{{ url_for('reiniciar_practica') }}", { method: "POST" })
      .then(r => r.json())
      .then(() => {
        document.getElementById("intentos").innerText = "0";
        document.getElementById("correctos").innerText = "0";
        document.getElementById("racha").innerText = "0";
        document.getElementById("precision").innerText = "0%";
        document.getElementById("precision-bar").style.width = "0%";
      });
  });

  async function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
      const landmarks = [];
      for (const lm of results.multiHandLandmarks[0]) {
        landmarks.push(lm.x, lm.y, lm.z);
      }

      drawConnectors(canvasCtx, results.multiHandLandmarks[0], HAND_CONNECTIONS,
        { color: "#00FF00", lineWidth: 2 });
      drawLandmarks(canvasCtx, results.multiHandLandmarks[0],
        { color: "#FF0000", lineWidth: 1 });

      // Enviar landmarks al backend
      fetch("/reconocer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ landmarks: landmarks })
      })
      .then(res => res.json())
      .then(data => {
        if (data.prediccion) {
          // Actualizar estad√≠sticas
          fetch("{{ url_for('status_practica') }}")
            .then(r => r.json())
            .then(stats => {
              document.getElementById("intentos").innerText = stats.intentos;
              document.getElementById("correctos").innerText = stats.correctos;
              document.getElementById("racha").innerText = stats.racha;
              document.getElementById("precision").innerText = stats.precision.toFixed(2) + "%";
              document.getElementById("precision-bar").style.width = stats.precision + "%";
            });
        }
      });
    }
    canvasCtx.restore();
  }
</script>
</body>
</html>

