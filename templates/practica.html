<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Practicando: {{ vocal }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='practica.css') }}">
  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0"></script>
</head>
<body>
  
<header>
  <div class="back-container">
    <a href="{{ url_for('index') }}" class="btn-back">‚¨Ö Volver</a>
  </div>
  <h2>Practicando: {{ vocal }}</h2>
  <p>Entrena con tu IA personalizada para mejorar tu precisi√≥n</p>
</header>

  <!-- M√©tricas -->
  <div class="metrics">
    <div class="metric">
      <h3>Intentos</h3>
      <p id="intentos">0</p>
    </div>
    <div class="metric">
      <h3>Correctos</h3>
      <p id="correctos">0</p>
    </div>
    <div class="metric">
      <h3>Racha Actual</h3>
      <p id="racha">0</p>
    </div>
    <div class="metric">
      <h3>Precisi√≥n</h3>
      <p id="precision">0%</p>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="main-content">
    <!-- C√°mara -->
    <div class="card">
      <h3>C√°mara de Aprendizaje</h3>

      <video id="camara" autoplay playsinline width="400" height="300" style="border:1px solid #ccc; position:absolute;"></video>
      <canvas id="output" width="400" height="300" style="border:1px solid #ccc; position:relative; z-index:10;"></canvas>

      <div class="controls">
        <button id="playBtn" class="btn-play">‚ñ∂Ô∏è Play</button>
        <button id="stopBtn" class="btn-stop">‚èπ Detener</button>
        <button id="resetBtn" class="btn-restart">üîÑ Reiniciar</button>
      </div>
    </div>

    <!-- Progreso -->
    <div class="card">
      <h3>Progreso de Aprendizaje</h3>
      <p><b>Objetivo Actual:</b> {{ vocal }}</p>

      <p>Progreso del Conjunto</p>
      <div class="progress-bar"><span id="progreso"></span></div>

      <p>Precisi√≥n de la Sesi√≥n</p>
      <div class="progress-bar"><span id="precision-bar"></span></div>

      <h4>Se√±ales Disponibles:</h4>
      <div class="signal-list">
        <div class="signal">A</div>
        <div class="signal">E</div>
        <div class="signal">I</div>
        <div class="signal">O</div>
        <div class="signal">U</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    import { HandLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

    const video = document.getElementById("camara");
    const canvas = document.getElementById("output");
    const ctx = canvas.getContext("2d");

    let handLandmarker;
    let running = false;

    async function init() {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
      );

      handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: "https://storage.googleapis.com/mediapipe-assets/hand_landmarker.task",
          delegate: "GPU"
        },
        runningMode: "VIDEO",
        numHands: 2
      });

      // encender c√°mara
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;

      video.onloadeddata = () => {
        running = true;
        detectHands();
      };
    }

    async function detectHands() {
      if (!running) return;

      const results = await handLandmarker.detectForVideo(video, performance.now());

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      if (results.landmarks) {
        const drawingUtils = new DrawingUtils(ctx);
        for (const landmarks of results.landmarks) {
          drawingUtils.drawConnectors(landmarks, HandLandmarker.HAND_CONNECTIONS, { color: "#00FF00", lineWidth: 2 });
          drawingUtils.drawLandmarks(landmarks, { color: "#FF0000", lineWidth: 1 });
        }
      }

      requestAnimationFrame(detectHands);
    }

    init();
  </script>

  <script>
    // Botones siguen funcionando con tu backend
    document.getElementById("playBtn").addEventListener("click", () => {
      fetch("{{ url_for('start_recognition') }}", { method: "POST" })
        .then(r => r.text())
        .then(data => console.log("‚ñ∂Ô∏è", data));
    });

    document.getElementById("stopBtn").addEventListener("click", () => {
      fetch("{{ url_for('stop_recognition') }}", { method: "POST" })
        .then(r => r.text())
        .then(data => console.log("‚èπ", data));
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      fetch("{{ url_for('reiniciar_practica') }}", { method: "POST" })
        .then(r => r.json())
        .then(data => {
          console.log("üîÑ", data);
          document.getElementById("intentos").innerText = "0";
          document.getElementById("correctos").innerText = "0";
          document.getElementById("racha").innerText = "0";
          document.getElementById("precision").innerText = "0%";
          document.getElementById("progreso").style.width = "0%";
          document.getElementById("precision-bar").style.width = "0%";
        });
    });

    setInterval(() => {
      fetch("{{ url_for('status_practica') }}")
        .then(r => r.json())
        .then(data => {
          document.getElementById("intentos").innerText = data.intentos;
          document.getElementById("correctos").innerText = data.correctos;
          document.getElementById("racha").innerText = data.racha;
          document.getElementById("precision").innerText = data.precision + "%";
          document.getElementById("progreso").style.width = data.progreso + "%";
          document.getElementById("precision-bar").style.width = data.precision + "%";
        });
    }, 2000);
  </script>
</body>
</html>

