<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Practicando: {{ vocal }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='practica.css') }}">
  <!-- Cargar MediaPipe Hands y Drawing -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
</head>
<body>
  
<header>
  <div class="back-container">
    <a href="{{ url_for('index') }}" class="btn-back">‚¨Ö Volver</a>
  </div>
  <h2>Practicando: {{ vocal }}</h2>
  <p>Entrena con tu IA personalizada para mejorar tu precisi√≥n</p>
</header>

  <!-- M√©tricas -->
  <div class="metrics">
    <div class="metric">
      <h3>Intentos</h3>
      <p id="intentos">0</p>
    </div>
    <div class="metric">
      <h3>Correctos</h3>
      <p id="correctos">0</p>
    </div>
    <div class="metric">
      <h3>Racha Actual</h3>
      <p id="racha">0</p>
    </div>
    <div class="metric">
      <h3>Precisi√≥n</h3>
      <p id="precision">0%</p>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="main-content">
    <!-- C√°mara -->
    <div class="card">
      <h3>C√°mara de Aprendizaje</h3>

      <!-- Video + Canvas -->
      <video id="camara" autoplay playsinline width="400" height="300" style="display:none;"></video>
      <canvas id="canvas" width="400" height="300" style="border:1px solid #ccc;"></canvas>

      <div class="controls">
        <button id="playBtn" class="btn-play">‚ñ∂Ô∏è Play</button>
        <button id="stopBtn" class="btn-stop">‚èπ Detener</button>
        <button id="resetBtn" class="btn-restart">üîÑ Reiniciar</button>
      </div>
    </div>

    <!-- Progreso -->
    <div class="card">
      <h3>Progreso de Aprendizaje</h3>
      <p><b>Objetivo Actual:</b> {{ vocal }}</p>

      <p>Progreso del Conjunto</p>
      <div class="progress-bar"><span id="progreso"></span></div>

      <p>Precisi√≥n de la Sesi√≥n</p>
      <div class="progress-bar"><span id="precision-bar"></span></div>

      <h4>Se√±ales Disponibles:</h4>
      <div class="signal-list">
        <div class="signal">A</div>
        <div class="signal">E</div>
        <div class="signal">I</div>
        <div class="signal">O</div>
        <div class="signal">U</div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    const video = document.getElementById("camara");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    // üöÄ MediaPipe Hands
    const hands = new Hands({
      locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
    });

    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.7,
      minTrackingConfidence: 0.7
    });

    hands.onResults((results) => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
      if (results.multiHandLandmarks) {
        for (const landmarks of results.multiHandLandmarks) {
          drawConnectors(ctx, landmarks, HAND_CONNECTIONS,
            {color: "#00FF00", lineWidth: 2});
          drawLandmarks(ctx, landmarks,
            {color: "#FF0000", lineWidth: 1, radius: 3});
        }
      }
    });

    const camera = new Camera(video, {
      onFrame: async () => {
        await hands.send({image: video});
      },
      width: 400,
      height: 300
    });
    camera.start();

    // Play
    document.getElementById("playBtn").addEventListener("click", () => {
      fetch("{{ url_for('start_recognition') }}", { method: "POST" })
        .then(r => r.text())
        .then(data => console.log("‚ñ∂Ô∏è", data));
    });

    // Stop
    document.getElementById("stopBtn").addEventListener("click", () => {
      fetch("{{ url_for('stop_recognition') }}", { method: "POST" })
        .then(r => r.text())
        .then(data => console.log("‚èπ", data));
    });

    // Reset
    document.getElementById("resetBtn").addEventListener("click", () => {
      fetch("{{ url_for('reiniciar_practica') }}", { method: "POST" })
        .then(r => r.json())
        .then(data => {
          console.log("üîÑ", data);
          document.getElementById("intentos").innerText = "0";
          document.getElementById("correctos").innerText = "0";
          document.getElementById("racha").innerText = "0";
          document.getElementById("precision").innerText = "0%";
          document.getElementById("progreso").style.width = "0%";
          document.getElementById("precision-bar").style.width = "0%";
        });
    });

    // üì° Actualizar estad√≠sticas cada 2 segundos
    setInterval(() => {
      fetch("{{ url_for('status_practica') }}")
        .then(r => r.json())
        .then(data => {
          document.getElementById("intentos").innerText = data.intentos;
          document.getElementById("correctos").innerText = data.correctos;
          document.getElementById("racha").innerText = data.racha;
          document.getElementById("precision").innerText = data.precision + "%";
          document.getElementById("progreso").style.width = data.progreso + "%";
          document.getElementById("precision-bar").style.width = data.precision + "%";
        });
    }, 2000);
  </script>
</body>
</html>
